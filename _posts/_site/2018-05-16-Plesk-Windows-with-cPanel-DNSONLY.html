<h1 id="how-to-use-plesk-slave-dns-manager-with-cpanel-dnsonly">How to use Plesk Slave DNS Manager with cPanel DNSONLY</h1>

<p>Plesk and cPanel are the main tools for hosting platforms nowadays. While both of them are very good and solid in Linux, Plesk is the only option when it comes to Windows, so one may have to use both tools to manage his/her hosting servers. Using two different tools on two different platforms (Windows and Linux) requires different bits of knowledge and sometimes, more resources. Centralized DNS is a good idea when it comes to optimizing the resources and reduce the management overhead. With Centralized DNS, you can be able to use a single set of name servers for all of the domains you host on your servers. Lucky for you, both cPanel and Plesk supports Centralized DNS but with different approaches. I, as many of the others, use Plesk for my Windows hosting platforms while using cPanel on Linux. cPanel DNSONLY is a good tool for Centralized DNS and It is easy to use and deploy. Plesk Windows, on the other hand, comes with Windows DNS and DNS Slave Extension can be used for Centralized DNS. Combining the two, on the other hand, is possible (in theory) but requires some tweaks on both sides. But using <strong>one master node to rule them all</strong> (see what I did there?) is a huge gain, so in this post, we will learn how to <strong>BIND</strong> them.</p>

<h3 id="install-plesk-dns-slave-extension">Install Plesk DNS Slave Extension</h3>

<p>Installing Plesk DNS Slave Extension is very straightforward and easy with using the Extensions Catalog in the Plesk UI. Just click <strong>Extensions</strong> in the side menu and search for the <strong>Slave DNS Manager</strong> and click install. After the installation has finished, click <strong>Go to Extension</strong> button to add DNS slaves.</p>

<p><img src="/assets/img/install_dns_slave.png" alt="Install Plesk DNS Slave Extension" height="500px" width="1000x" /></p>

<p><img src="/assets/img/go_dns.png" alt="Go to Plesk DNS Slave Extension" height="500px" width="1000x" /></p>

<h3 id="setting-up-slave-dns-servers">Setting Up Slave DNS Servers</h3>

<p>cPanel DNSONLY installation contains three simple steps wich can be summerized as;</p>

<p>1) Go to home directory;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /home
</code></pre></div></div>
<p>2) Download installation script;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-o</span> latest-dnsonly <span class="nt">-L</span> https://securedownloads.cpanel.net/latest-dnsonly
</code></pre></div></div>
<p>3) Execute;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh latest-dnsonly
</code></pre></div></div>
<p>The installation process can fail if your operating system is using NetworkManager so you might want to disable NetworkManager and use network service instead. Check out this link for more information; <a href="https://www.thegeekdiary.com/centos-rhel-7-how-to-disable-networkmanager/">How to disable NetworkManager on CentOS / RHEL 7</a></p>

<h3 id="adding-dns-slaves">Adding DNS Slaves</h3>

<p>After the installation, one can easily add DNS slaves to the system with few simple steps;</p>

<p><img src="/assets/img/addslave.jpg" alt="Add DNS Slave" height="500px" width="1000x" /></p>

<p>1) Enter Slave DNS address</p>

<p>2) Change Secret key with your own secret on your cPanel DNS server</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>more /etc/rndc.key
</code></pre></div></div>
<p>3) Save your old named.conf as named.conf.old, create new config file on your cPanel DNSONLY server and add required lines;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mv</span> /etc/named.conf /etc/named.conf.old
vi /etc/named.conf
</code></pre></div></div>
<p>and add required lines. Your <strong>named.conf</strong> should look like this;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include <span class="s2">"/etc/rndc.key"</span><span class="p">;</span>

controls <span class="o">{</span>
        inet <span class="k">*</span> port 953 allow <span class="o">{</span> YOUR PLESK SERVER IP<span class="p">;</span> 127.0.0.1<span class="p">;</span><span class="o">}</span> keys <span class="o">{</span> <span class="s2">"rndc-key"</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>

acl trusted <span class="o">{</span>

     YOUR PLESK SERVER IP<span class="p">;</span>
     DNSONLY IP<span class="p">;</span>
<span class="o">}</span><span class="p">;</span>

options <span class="o">{</span>
        listen-on port 53 <span class="o">{</span> 127.0.0.1<span class="p">;</span> YOUR PLESK SERVER IP<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
        listen-on-v6 port 53 <span class="o">{</span> ::1<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
        directory       <span class="s2">"/var/named"</span><span class="p">;</span>
        dump-file       <span class="s2">"/var/named/data/cache_dump.db"</span><span class="p">;</span>
        statistics-file <span class="s2">"/var/named/data/named_stats.txt"</span><span class="p">;</span>
        memstatistics-file <span class="s2">"/var/named/data/named_mem_stats.txt"</span><span class="p">;</span>
        allow-new-zones <span class="nb">yes</span><span class="p">;</span>
        allow-transfer <span class="o">{</span> YOUR PLESK SERVER IP<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
        masterfile-format text<span class="p">;</span>
        
        recursion no<span class="p">;</span>

        dnssec-enable <span class="nb">yes</span><span class="p">;</span>
        dnssec-validation <span class="nb">yes</span><span class="p">;</span>

        /<span class="k">*</span> Path to ISC DLV key <span class="k">*</span>/
        bindkeys-file <span class="s2">"/etc/named.iscdlv.key"</span><span class="p">;</span>

        managed-keys-directory <span class="s2">"/var/named/dynamic"</span><span class="p">;</span>

        pid-file <span class="s2">"/run/named/named.pid"</span><span class="p">;</span>
        session-keyfile <span class="s2">"/run/named/session.key"</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>

logging <span class="o">{</span>
        channel default_debug <span class="o">{</span>
                file <span class="s2">"data/named.run"</span><span class="p">;</span>
                severity dynamic<span class="p">;</span>
        <span class="o">}</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>

zone <span class="s2">"."</span> IN <span class="o">{</span>
        <span class="nb">type </span>hint<span class="p">;</span>
        file <span class="s2">"named.ca"</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>

include <span class="s2">"/etc/named.rfc1912.zones"</span><span class="p">;</span>
include <span class="s2">"/etc/named.root.key"</span><span class="p">;</span>
</code></pre></div></div>
<p>and restart your BIND using;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service named restart
</code></pre></div></div>

<p>4) Click OK to continue.</p>

<h3 id="change-windows-dns-to-bind-on-plesk">Change Windows DNS to BIND on Plesk</h3>

<p>Default Plesk installation comes with Windows DNS but we have to switch it to BIND in order to integrate it with cPanel DNSONLY. To do this;</p>

<ol>
  <li>Go to Tools &amp; Settings &gt; Updates and Upgrades and install the BIND DNS server using the Plesk Installer.</li>
  <li>Go to Tools &amp; Settings &gt; Server Components and click DNS Server.</li>
  <li>Select BIND DNS Server and click OK.</li>
</ol>

<h3 id="exterminate-the-bug-on-plesk-windows">Exterminate the Bug on Plesk Windows</h3>

<p>Plesk Windows comes with a bug which causes DNS zones served by Bind DNS server on Windows are not synced with the slave DNS. As a workaround;</p>

<ol>
  <li>Connect to the server via RDP</li>
  <li>Create Plesk database backup (optional)</li>
  <li>Add fallowing line into Plesk Database Manually</li>
</ol>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plesk</span> <span class="n">db</span> <span class="nv">"REPLACE INTO misc VALUES ('DNS_Allow_Transfer0', 'YOUR SLAVE IP');"</span>
</code></pre></div></div>

<p>You can find more information about this bug in here; <a href="https://support.plesk.com/hc/en-us/articles/115003832434-Zones-are-not-transferred-from-Bind-on-Windows"> Zones are not transferred from Bind on Windows </a>.</p>

<h3 id="enjoy-your-new-centralized-dns-setup">Enjoy Your New Centralized DNS Setup</h3>

<p>Your Centralized DNS setup is ready to go, but you might want to correct one more thing if you want to use your new setup with cPanel DNS Clusters. cPanel stores DNS records in <strong>domain.ltd.db</strong> format instead of <strong>domain.ltd</strong> and this causes malfunctions (read as DNS clusters are not syncing) on DNS Cluster setup. In order to overcome this, rename your DNS records as <strong>domain.ltd.db</strong> and manually push your records on your master cPanel DNS ONLY server with;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/scripts/dnscluster syncall <span class="nt">--full</span>
</code></pre></div></div>
<p>you can also automate this process with simple script added on cron jobs. And thatâ€™s it! Enjoy your new centralized DNS setup with Plesk DNS Slave Manager and cPanel DNSONLY!</p>
